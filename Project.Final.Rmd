---
title: "Project.Final"
author: "Leslie Speight Youtsey and Liz Weatherup"
date: "11/13/2020"
output:
  html_document:
    df_print: paged
---

# Title : Fluxes in the ocean 

# Abstract: 

# Introduction: 

# Toolbox discussion:

# Description:

# Implementation:

### Reading csv data in 

```{r}
rm(list=ls(all=TRUE))  #Housekeeping: clear out old files

options(warn = -1)
knitr::opts_chunk$set(echo = T, fig.height=6, fig.width=8, warning = F, message = F) 

```

```{r, eval=TRUE}
bats_flux <- read.csv("bats_flux.csv")

delete.na <- function(DF, n=0) {
  DF[rowSums(is.na(DF)) <= n,]
} #Function that takes rows out that contains NAs 
bats_flux.noNA <- delete.na(bats_flux) # Take out rows containing NAs 

# Too many observations taken out, lets subset a new data frame

Data <- subset(bats_flux,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","M_avg","C_avg","N_avg","P_avg"))
Data.noNA <- delete.na(Data)

# now we can use Data.noNA to compare each flux to one another, since no flux contains NAs

```

Here is what our data looks like 

```{r}
head(Data)
```

### Subsetting each flux out seperatly 

```{r,eval=TRUE}
# separate each flux into its own dataframe 
# delete rows that contain NAs 
C_flux.data <- delete.na(subset(Data,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","C_avg")))
N_flux.data <- delete.na(subset(Data,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","N_avg")))
P_flux.data <- delete.na(subset(Data,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","P_avg")))
M_flux.data <- delete.na(subset(Data,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","M_avg")))
```

### Subseting each depth and Renaming Columns 

```{r,eval=TRUE}
# Subset each depth and rename columns 
library(tidyverse)
library(dplyr)
# use tideyverse instead
C_flux.depth.150 <- subset(C_flux.data, dep == 150)
C_flux.depth.150 <- rename(C_flux.depth.150,c("dep.150" = "dep"))
C_flux.depth.150 <- rename(C_flux.depth.150, c("C_avg.150" = "C_avg" ))
C_flux.depth.200 <- subset(C_flux.data, dep == 200)
C_flux.depth.200 <- rename(C_flux.depth.200, c("dep.200"="dep"))
C_flux.depth.200 <- rename(C_flux.depth.200, c("C_avg.200" ="C_avg"))
C_flux.depth.300 <- subset(C_flux.data, dep == 300)
C_flux.depth.300 <- rename(C_flux.depth.300, c("dep.300"="dep"))
C_flux.depth.300 <- rename(C_flux.depth.300, c("C_avg.300" ="C_avg"))
C_flux.depth.400 <- subset(C_flux.data, dep == 400)
C_flux.depth.400 <- rename(C_flux.depth.400, c("dep.400"="dep"))
C_flux.depth.400 <- rename(C_flux.depth.400, c("C_avg.400" ="C_avg"))
```

```{r,eval=TRUE}
N_flux.depth.150 <- subset(N_flux.data, dep == 150)
N_flux.depth.150 <- rename(N_flux.depth.150, c("dep.150"="dep"))
N_flux.depth.150 <- rename(N_flux.depth.150, c("N_avg.150" ="N_avg"))
N_flux.depth.200 <- subset(N_flux.data, dep == 200)
N_flux.depth.200 <- rename(N_flux.depth.200, c("dep.200"="dep"))
N_flux.depth.200 <- rename(N_flux.depth.200, c("N_avg.200" ="N_avg"))
N_flux.depth.300 <- subset(N_flux.data, dep == 300)
N_flux.depth.300 <- rename(N_flux.depth.300, c("dep.300"="dep"))
N_flux.depth.300 <- rename(N_flux.depth.300, c("N_avg.300" ="N_avg"))
N_flux.depth.400 <- subset(N_flux.data, dep == 400)
N_flux.depth.400 <- rename(N_flux.depth.400, c("dep.400"="dep"))
N_flux.depth.400 <- rename(N_flux.depth.400, c("N_avg.400" ="N_avg"))
```

```{r,eval=TRUE}
P_flux.depth.150 <- subset(P_flux.data, dep == 150)
P_flux.depth.150 <- rename(P_flux.depth.150, c("dep.150"="dep"))
P_flux.depth.150 <- rename(P_flux.depth.150, c("P_avg.150" ="P_avg"))
P_flux.depth.200 <- subset(P_flux.data, dep == 200)
P_flux.depth.200 <- rename(P_flux.depth.200, c("dep.200"="dep"))
P_flux.depth.200 <- rename(P_flux.depth.200, c("P_avg.200" ="P_avg"))
P_flux.depth.300 <- subset(P_flux.data, dep == 300)
P_flux.depth.300 <- rename(P_flux.depth.300, c("dep.300"="dep"))
P_flux.depth.300 <- rename(P_flux.depth.300, c("P_avg.300" ="P_avg"))
P_flux.depth.400 <- subset(P_flux.data, dep == 400)
P_flux.depth.400 <- rename(P_flux.depth.400, c("dep.400"="dep"))
P_flux.depth.400 <- rename(P_flux.depth.400, c("P_avg.400" ="P_avg"))
```

```{r,eval=TRUE}
M_flux.depth.150 <- subset(M_flux.data, dep == 150)
M_flux.depth.150 <- rename(M_flux.depth.150, c("dep.150"="dep"))
M_flux.depth.150 <- rename(M_flux.depth.150, c("M_avg.150" ="M_avg"))
M_flux.depth.200 <- subset(M_flux.data, dep == 200)
M_flux.depth.200 <- rename(M_flux.depth.200, c("dep.200"="dep"))
M_flux.depth.200 <- rename(M_flux.depth.200, c("M_avg.200" ="M_avg"))
M_flux.depth.300 <- subset(M_flux.data, dep == 300)
M_flux.depth.300 <- rename(M_flux.depth.300, c("dep.300"="dep"))
M_flux.depth.300 <- rename(M_flux.depth.300, c("M_avg.300" ="M_avg"))
M_flux.depth.400 <- subset(M_flux.data, dep == 400)
M_flux.depth.400 <- rename(M_flux.depth.400, c("dep.400"="dep"))
M_flux.depth.400 <- rename(M_flux.depth.400, c("M_avg.400" ="M_avg"))
```

### Bar plots to access relationship between fluxes and depths 

n values for C-flux

```{r}
#n values for C-flux
length(which(Data.noNA$dep == "150" & Data.noNA$C_avg))
length(which(Data.noNA$dep == "200" & Data.noNA$C_avg))
length(which(Data.noNA$dep == "300" & Data.noNA$C_avg))
length(which(Data.noNA$dep == "400" & Data.noNA$C_avg))

```

Mean and SE of each depth of C-flux

```{r}
dep150 <- subset(C_flux.data, dep=="150") #focusing on mean of C-avg at depth 150

muCflux150 <- mean(dep150$C_avg, data=dep150)

s.e150c <- muCflux150 * sqrt(105)  #need to find s.e

dep200 <- subset(C_flux.data, dep=="200") #focusing on mean of C-avg at depth 200

muCflux200 <- mean(dep200$C_avg, data=dep200)

s.e200c <- muCflux200 * sqrt(102)

dep300 <- subset(C_flux.data, dep=="300") #focusing on mean of C-avg at depth 300

muCflux300 <- mean(dep300$C_avg, data=dep300)

s.e300c <- muCflux300 * sqrt(98)

dep400 <- subset(C_flux.data, dep=="400") #focusing on mean of C-avg at depth 400

muCflux400 <- mean(dep400$C_avg, data=dep400)

s.e400c <- muCflux400 * sqrt(0)

bar.Cflux <- data.frame(c("dep150","dep200","dep300","dep400"), c(muCflux150,muCflux200,muCflux300,muCflux400))
colnames(bar.Cflux)[1] <- "Depth"
colnames(bar.Cflux)[2] <- "C_fluxMean"
```

Graph of C-flux

```{r}
library(ggplot2)
library(dplyr)
library(viridisLite)

Viridis_palette <- viridis(40)[seq(1,40, 2)]
xval <- bar.Cflux$Depth #character objects need quotes
yval <- bar.Cflux$`C_flux Mean`

ggplot()+geom_col(bar.Cflux, mapping=aes(x= Depth, y = C_fluxMean), color="#e9ecef", alpha=0.6,) +                                     
xlab("Depth (m)") + ylab("Mean of C Flux(mg carbon m^-2 day^-1)") +                
                                           
 theme(text = element_text(family = 'serif')) +                       
scale_fill_manual(values = Viridis_palette)                        
  


```


##C-flux decreasing with depth

```{r}
#n values for P-flux
length(which(Data.noNA$dep == "150" & Data.noNA$P_avg))
length(which(Data.noNA$dep == "200" & Data.noNA$P_avg))
length(which(Data.noNA$dep == "300" & Data.noNA$P_avg))
length(which(Data.noNA$dep == "400" & Data.noNA$P_avg))
```


Mean and SE of each depth of P-flux

```{r}
dep150p <- subset(P_flux.data, dep=="150") #focusing on mean of P-avg at depth 150

muPflux150 <- mean(dep150p$P_avg, data=dep150p)

s.e150p <- muPflux150 * sqrt(105)  #need to find s.e

dep200p <- subset(P_flux.data, dep=="200") #focusing on mean of P-avg at depth 200

muPflux200 <- mean(dep200p$P_avg, data=dep200p)

s.e200p <- muPflux200 * sqrt(102)

dep300p <- subset(P_flux.data, dep=="300") #focusing on mean of P-avg at depth 300

muPflux300 <- mean(dep300p$P_avg, data=dep300p)


s.e300p <- muPflux300 * sqrt(98)

#dep400p <- subset(P_flux.data, dep=="400")
#muPflux400 <- mean(dep400p$P_avg, data=dep400p)

#s.e400p <- muPflux400 * sqrt(0)

bar.Pflux <- data.frame(c("dep150","dep200","dep300"), c(muPflux150,muPflux200,muPflux300))
colnames(bar.Pflux)[1] <- "Depth"
colnames(bar.Pflux)[2] <- "P_fluxMean"
```

Graph of P-flux 

```{r}
library(ggplot2)
library(dplyr)
library(viridisLite)

Viridis_palette <- viridis(40)[seq(1,40, 2)]
xval <- bar.Pflux$Depth #character objects need quotes
yval <- bar.Pflux$`P_flux Mean`

ggplot()+geom_col(bar.Pflux, mapping=aes(x= Depth, y = P_fluxMean), color="#e9ecef", alpha=0.6,) +                                     
xlab("Depth (m)") + ylab("Mean of P Flux(mg phospohorous m^-2 day^-1)") +                
                                           
 theme(text = element_text(family = 'serif')) +                       
scale_fill_manual(values = Viridis_palette)                        
```

##P-flux decreaing with depth

```{r}

#n values for N-flux
length(which(Data.noNA$dep == "150" & Data.noNA$N_avg))
length(which(Data.noNA$dep == "200" & Data.noNA$N_avg))
length(which(Data.noNA$dep == "300" & Data.noNA$N_avg))
length(which(Data.noNA$dep == "400" & Data.noNA$N_avg))



```

Mean and SE of each depth of N-flux

```{r}
dep150n <- subset(N_flux.data, dep=="150") #focusing on mean of N-avg at depth 150

muNflux150 <- mean(dep150n$N_avg, data=dep150n)

s.e150n <- muNflux150 * sqrt(105)  #need to find s.e

dep200n <- subset(N_flux.data, dep=="200") #focusing on mean of N-avg at depth 200

muNflux200 <- mean(dep200n$N_avg, data=dep200n)

s.e200n <- muNflux200 * sqrt(102)

dep300n <- subset(N_flux.data, dep=="300") #focusing on mean of N-avg at depth 300

muNflux300 <- mean(dep300n$N_avg, data=dep300n)

s.e300n <- muNflux300 * sqrt(98)

dep400n <- subset(N_flux.data, dep=="400") #focusing on mean of N-avg at depth 400

muNflux400 <- mean(dep400n$N_avg, data=dep400n)

s.e400n <- muNflux400 * sqrt(0)

bar.Nflux <- data.frame(c("dep150","dep200","dep300","dep400"), c(muNflux150,muNflux200,muNflux300,muNflux400))
colnames(bar.Nflux)[1] <- "Depth"
colnames(bar.Nflux)[2] <- "N_fluxMean"
```

Graph of N-flux

```{r}
library(ggplot2)
library(dplyr)
library(viridisLite)

Viridis_palette <- viridis(40)[seq(1,40, 2)]
xval <- bar.Nflux$Depth #character objects need quotes
yval <- bar.Nflux$`N_flux Mean`

ggplot()+geom_col(bar.Nflux, mapping=aes(x= Depth, y = N_fluxMean), color="#e9ecef", alpha=0.6,) +                                     
xlab("Depth (m)") + ylab("Mean of N Flux(mg nitrogen m^-2 day^-1)") +                
                                           
 theme(text = element_text(family = 'serif')) +                       
scale_fill_manual(values = Viridis_palette)                        
```

#N-flux decreasing with depth


```{r}
#n values for M-flux
length(which(Data.noNA$dep == "150" & Data.noNA$M_avg))
length(which(Data.noNA$dep == "200" & Data.noNA$M_avg))
length(which(Data.noNA$dep == "300" & Data.noNA$M_avg))
length(which(Data.noNA$dep == "400" & Data.noNA$M_avg))


```
Mean and SE of each depth of M-flux

```{r}
dep150m <- subset(M_flux.data,dep=="150") #focusing on mean of C-avg at depth 150

muMflux150 <- mean(dep150m$M_avg, data=dep150m)

s.e150m <- muMflux150 * sqrt(105)  #need to find s.e

dep200m <- subset(M_flux.data, dep=="200") #focusing on mean of C-avg at depth 200

muMflux200 <- mean(dep200m$M_avg, data=dep200m)

s.e200m <- muMflux200 * sqrt(102)

dep300m <- subset(M_flux.data, dep=="300") #focusing on mean of C-avg at depth 300

muMflux300 <- mean(dep300m$M_avg, data=dep300m)

s.e300m <- muMflux300 * sqrt(98)

dep400m <- subset(M_flux.data, dep=="400") #focusing on mean of C-avg at depth 400

muMflux400 <- mean(dep400m$M_avg, data=dep400m)

s.e400m <- muMflux400 * sqrt(00)

bar.Mflux <- data.frame(c("dep150","dep200","dep300","dep400"), c(muMflux150,muMflux200,muMflux300,muMflux400))
colnames(bar.Mflux)[1] <- "Depth"
colnames(bar.Mflux)[2] <- "M_fluxMean"
```

Graph of M-flux

```{r}
library(ggplot2)
library(dplyr)
library(viridisLite)

Viridis_palette <- viridis(40)[seq(1,40, 2)]
xval <- bar.Mflux$Depth #character objects need quotes
yval <- bar.Mflux$`M_flux Mean`

ggplot()+geom_col(bar.Mflux, mapping=aes(x= Depth, y = M_fluxMean), color="#e9ecef", alpha=0.6,) +                                     
xlab("Depth (m)") + ylab("Mean of M Flux(mg mass m^-2 day^-1)") +                
                                           
 theme(text = element_text(family = 'serif')) +                       
scale_fill_manual(values = Viridis_palette)                        
```

##M-flux decreasing with depth
<br>

#### Distribution  and box plot of our data by depth 

```{r,eval=TRUE}
# Checking for normaility and no outliers in Carbon Flux 
par(mfrow=c(1,4))
hist((C_flux.depth.150$C_avg.150))
hist((C_flux.depth.200$C_avg.200))
hist((C_flux.depth.300$C_avg.300))
hist((C_flux.depth.400$C_avg.400))

# using natural log to Transform the data 
par(mfrow=c(1,4))
hist(log(C_flux.depth.150$C_avg.150))
hist(log(C_flux.depth.200$C_avg.200))
hist(log(C_flux.depth.300$C_avg.300))
hist(log(C_flux.depth.400$C_avg.400))

# Checking for outliers
par(mfrow=c(1,4))
boxplot(log(C_flux.depth.150$C_avg.150))
boxplot(log(C_flux.depth.200$C_avg.200))
boxplot(log(C_flux.depth.300$C_avg.300))
boxplot(log(C_flux.depth.400$C_avg.400))
```

##Needed to log transform data to make it more normal
##boxplot means do not overlap, but box sizes for 150, 200, and 300 seem to be similar in box size as well as whisker length which means that they could be good predictors of each other and do not break homoscedasticity. However, the 400 depth has a lot of overlap and a very different shape which could break homosedasticity.



```{r,eval=TRUE}
# Checking for normaility and no outliers in Nitrogen Flux 
par(mfrow=c(1,4))
hist((N_flux.depth.150$N_avg.150), breaks = "FD")
hist((N_flux.depth.200$N_avg.200), breaks = "FD")
hist((N_flux.depth.300$N_avg.300), breaks = "FD")
hist((N_flux.depth.400$N_avg.400), breaks = "FD")

# using natural log to Transform the data 
par(mfrow=c(1,4))
hist(log(N_flux.depth.150$N_avg.150))
hist(log(N_flux.depth.200$N_avg.200))
hist(log(N_flux.depth.300$N_avg.300))
hist(log(N_flux.depth.400$N_avg.400))

# Checking for outliers
par(mfrow=c(1,4))
boxplot(log(N_flux.depth.150$N_avg.150))
boxplot(log(N_flux.depth.200$N_avg.200))
boxplot(log(N_flux.depth.300$N_avg.300))
boxplot(log(N_flux.depth.400$N_avg.400))
```

##Needed to log transform data to make it more normal
##boxplot means do not too seem to overlab too much for 150 and 200, but ther is a bit of overlap in 200 and 300. 150, 200, and 300 seem to be similar in box size as well as whisker length which means that they could be good predictors of each other and do not break homoscedasticity. However, the 400 depth has a lot of overlap and a very different shape which could break homosedasticity.


```{r,eval=TRUE}
# Checking for normaility and no outliers in Phosporous Flux 
par(mfrow=c(1,3))
hist((P_flux.depth.150$P_avg.150), breaks = "FD")
hist((P_flux.depth.200$P_avg.200), breaks = "FD")
hist((P_flux.depth.300$P_avg.300), breaks = "FD")

# using natural log to Transform the data 
par(mfrow=c(1,3))
hist(log(P_flux.depth.150$P_avg.150))
hist(log(P_flux.depth.200$P_avg.200))
hist(log(P_flux.depth.300$P_avg.300))

# Checking for outliers
par(mfrow=c(1,3))
boxplot(log(P_flux.depth.150$P_avg.150))
boxplot(log(P_flux.depth.200$P_avg.200))
boxplot(log(P_flux.depth.300$P_avg.300))
```

##Needed to log transform data to make it more normal
##boxplot means seem to have some overlap. They are similar in box size, but the concern is the overlap, making them not good predictors of one another and potentially breaking homosedasticity.

```{r,eval=TRUE}
# Checking for normaility and no outliers in Mass Flux 
par(mfrow=c(1,4))
hist((M_flux.depth.150$M_avg.150), breaks = "FD")
hist((M_flux.depth.200$M_avg.200), breaks = "FD")
hist((M_flux.depth.300$M_avg.300), breaks = "FD")
hist((M_flux.depth.400$M_avg.400), breaks = "FD")

# using natural log to Transform the data 
par(mfrow=c(1,4))
hist(log(M_flux.depth.150$M_avg.150))
hist(log(M_flux.depth.200$M_avg.200))
hist(log(M_flux.depth.300$M_avg.300))
hist(log(M_flux.depth.400$M_avg.400))

# Checking for outliers
par(mfrow=c(1,4))
boxplot(log(M_flux.depth.150$M_avg.150))
boxplot(log(M_flux.depth.200$M_avg.200))
boxplot(log(M_flux.depth.300$M_avg.300))
boxplot(log(M_flux.depth.400$M_avg.400))
```

##Needed to log transform data to make it more normal
##boxplot means seem to have some overlap. They are similar in box size, but the concern is the overlap, making them not good predictors of one another and potentially breaking homosedasticity.

*Since many of the 400 m depth distrubutions were not normal, even after transformation and have small n, they will not be used in the hypothesis testing* 

<br>

### Paired sample t test for each depth and the depth below it 

This is a paired test because samples were collected on the same cruise and at the same location. So for each flux value at one depth, there was a flux value collected at a different depth at the same location!
Data frames were merged based on cruise, year, and location to have the same number of values.  

For a paired t test to be preformed it must meet these assumptions:

$\overline{Y_1}$ - $\overline{Y_2}$ = $\overline{D}$

  +The dependent variable must be continuous (interval/ratio). $\checkmark$

##can take this out ## +The observations are independent of one another. $\checkmark$ 

  +The dependent variable ($\overline{D}$) should be approximately normally distributed. $\checkmark$

  +The dependent variable ($\overline{D}$) should not contain any outliers. $\Box$


```{r}
#create D-bar for each paired group
C.depth.150.200 <- merge(C_flux.depth.150,C_flux.depth.200,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))
C.depth.150.200$D_bar <- C.depth.150.200$C_avg.150 - C.depth.150.200$C_avg.200

C.depth.200.300 <- merge(C_flux.depth.200,C_flux.depth.300,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))
C.depth.200.300$D_bar <- C.depth.200.300$C_avg.200 - C.depth.200.300$C_avg.300

N.depth.150.200 <- merge(N_flux.depth.150,N_flux.depth.200,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))
N.depth.150.200$D_bar <- N.depth.150.200$N_avg.150 - N.depth.150.200$N_avg.200

N.depth.200.300 <- merge(N_flux.depth.200,N_flux.depth.300,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))
N.depth.200.300$D_bar <- N.depth.200.300$N_avg.200 - N.depth.200.300$N_avg.300

P.depth.150.200 <- merge(P_flux.depth.150,P_flux.depth.200,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))
P.depth.150.200$D_bar <- P.depth.150.200$P_avg.150 - P.depth.150.200$P_avg.200

P.depth.200.300 <- merge(P_flux.depth.200,P_flux.depth.300,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))
P.depth.200.300$D_bar <- P.depth.200.300$P_avg.200 - P.depth.200.300$P_avg.300

M.depth.150.200 <- merge(M_flux.depth.150,M_flux.depth.200,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))
M.depth.150.200$D_bar <- M.depth.150.200$M_avg.150 - M.depth.150.200$M_avg.200

M.depth.200.300 <- merge(M_flux.depth.200,M_flux.depth.300,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))
M.depth.200.300$D_bar <- M.depth.200.300$M_avg.200 - M.depth.200.300$M_avg.300
```

```{r}
#check distribution of D-bar (difference between paried depth samples)

# Carbon 
par(mfrow=c(1,3))
hist(C.depth.150.200$D_bar, breaks = "FD")
hist(log(C.depth.150.200$D_bar), breaks = "FD") #try lo transform 
boxplot(log(C.depth.150.200$D_bar)) #lots of outliers 

par(mfrow=c(1,3))
hist(C.depth.200.300$D_bar, breaks = "FD")
hist(log(C.depth.200.300$D_bar), breaks = "FD") #try lo transform 
boxplot(log(C.depth.200.300$D_bar)) #lots of outliers 

# Nitrogen
par(mfrow=c(1,3))
hist(N.depth.150.200$D_bar, breaks = "FD")
hist(log(N.depth.150.200$D_bar), breaks = "FD") #try lo transform 
boxplot(log(N.depth.150.200$D_bar)) #lots of outliers 

par(mfrow=c(1,3))
hist(N.depth.200.300$D_bar, breaks = "FD")
hist(log(N.depth.200.300$D_bar), breaks = "FD") #try lo transform 
boxplot(log(N.depth.200.300$D_bar)) #lots of outliers 

# Phosphorous
par(mfrow=c(1,3))
hist(P.depth.150.200$D_bar, breaks = "FD")
hist(log(P.depth.150.200$D_bar), breaks = "FD") #try lo transform 
boxplot(log(P.depth.150.200$D_bar)) #lots of outliers 

par(mfrow=c(1,3))
hist(P.depth.200.300$D_bar, breaks = "FD")
hist(log(P.depth.200.300$D_bar), breaks = "FD") #try lo transform 
boxplot(log(P.depth.200.300$D_bar)) #lots of outliers 

# Mass 
par(mfrow=c(1,3))
hist(M.depth.150.200$D_bar, breaks = "FD")
hist(log(M.depth.150.200$D_bar), breaks = "FD") #try lo transform 
boxplot(log(M.depth.150.200$D_bar)) #lots of outliers 

par(mfrow=c(1,3))
hist(M.depth.200.300$D_bar, breaks = "FD")
hist(log(M.depth.200.300$D_bar), breaks = "FD") #try lo transform 
boxplot(log(M.depth.200.300$D_bar)) #lots of outliers 
```

##Cdepth (150.200) is not very normal even with a log transformation and the residual is not around 0
##Cdepth (200.300) is fairly normal with a log transformation, but the residual is not around 0
##Ndepth (150.200) is not very normal even with a log transformation, but the residual is close to 0
##Ndepth (200.300) is fairly normal with a log transformation, and the residual is around 0
##Pdepth (150.200) is not very normal even with a log transformation and the residual is not around 0
##Pdepth (200.300) is not very normal even with a log transformation and the residual is not around 0
##Mdepth (150.200) is fairly normal with a log transformation, but the residual is not around 0
##Mdepth (200.300) is fairly normal with a log transformation, but the residual is not around 0
(1.1)

$\mu_1$ = mean Carbon flux at depth 150
$\mu_2$ = mean Carbon flux at depth 200

$H_0$ : Carbon flux does not change between 150 and 200 meter. $\mu_1$ = $\mu_2$
$H_1$ : Carbon flux is lower at 200 meter then at 150 meter. $\mu_1$ > $\mu_2$



```{r}
t.test(log(C.depth.150.200$C_avg.150) ,log(C.depth.150.200$C_avg.200), alternative = "greater", paired = TRUE, var.equal = TRUE)

```

##super low p-value,significant, reject the null
(1.2)

$\mu_1$ = mean Carbon flux at depth 200
$\mu_2$ = mean Carbon flux at depth 300

$H_0$ : Carbon flux does not change between 200 and 300 meter. $\mu_1$ = $\mu_2$
$H_1$ : Carbon flux is lower at 300 meter then at 200 meter. $\mu_1$ > $\mu_2$

```{r}
t.test(log(C.depth.200.300$C_avg.200) ,log(C.depth.200.300$C_avg.300), alternative = "greater", paired = TRUE, var.equal = TRUE)
```

##very low pval. We reject the null, significant
(2.1)

$\mu_1$ = mean Nitrogen flux at depth 150
$\mu_2$ = mean Nitrogen flux at depth 200

$H_0$ : Nitrogen flux does not change between 150 and 200 meter. $\mu_1$ = $\mu_2$
$H_1$ : Nitrogen flux is lower at 200 meter then at 150 meter. $\mu_1$ > $\mu_2$

```{r}
t.test(log(N.depth.150.200$N_avg.150) ,log(N.depth.150.200$N_avg.200), alternative = "greater", paired = TRUE, var.equal = TRUE)
```

##super low p-value,significant, reject the null
(2.2)

$\mu_1$ = mean Nitrogen flux at depth 200
$\mu_2$ = mean Nitrogen flux at depth 300

$H_0$ : Nitrogen flux does not change between 200 and 300 meter. $\mu_1$ = $\mu_2$
$H_1$ : Nitrogen flux is lower at 300 meter then at 200 meter. $\mu_1$ > $\mu_2$

```{r}
t.test(log(N.depth.200.300$N_avg.200) ,log(N.depth.200.300$N_avg.300), alternative = "greater", paired = TRUE, var.equal = TRUE)
```
##super low p-value,significant, reject the null
(3.1)

$\mu_1$ = mean Phosporous flux at depth 150
$\mu_2$ = mean Phosporous flux at depth 200

$H_0$ : Phosporous flux does not change between 150 and 200 meter. $\mu_1$ = $\mu_2$
$H_1$ : Phosporous flux is lower at 200 meter then at 150 meter. $\mu_1$ > $\mu_2$

```{r}
t.test(log(P.depth.150.200$P_avg.150) ,log(P.depth.150.200$P_avg.200), alternative = "greater", paired = TRUE, var.equal = TRUE)
```
##super low p-value,significant, reject the null
(3.2)

$\mu_1$ = mean Phosporous flux at depth 200
$\mu_2$ = mean Phosporous flux at depth 300

$H_0$ : Phosporous flux does not change between 200 and 300 meter. $\mu_1$ = $\mu_2$
$H_1$ : Phosporous flux is lower at 300 meter then at 200 meter. $\mu_1$ > $\mu_2$

```{r}
t.test(log(P.depth.200.300$P_avg.200) ,log(P.depth.200.300$P_avg.300), alternative = "greater", paired = TRUE, var.equal = TRUE)
```
##super low p-value,significant, reject the null
(4.1)

$\mu_1$ = mean Mass flux at depth 150
$\mu_2$ = mean Mass flux at depth 200

$H_0$ : Mass flux does not change between 150 and 200 meter. $\mu_1$ = $\mu_2$
$H_1$ : Mass flux is lower at 200 meter then at 150 meter. $\mu_1$ > $\mu_2$

```{r}
t.test(log(M.depth.150.200$M_avg.150) ,log(M.depth.150.200$M_avg.200), alternative = "greater", paired = TRUE, var.equal = TRUE)
```
##super low p-value,significant, reject the null
(4.2)

$\mu_1$ = mean Mass flux at depth 200
$\mu_2$ = mean Mass flux at depth 300

$H_0$ : Mass flux does not change between 200 and 300 meter. $\mu_1$ = $\mu_2$
$H_1$ : Mass flux is lower at 300 meter then at 200 meter. $\mu_1$ > $\mu_2$

```{r}
t.test(log(M.depth.200.300$M_avg.200) ,log(M.depth.200.300$M_avg.300), alternative = "greater", paired = TRUE, var.equal = TRUE)
```
##super low p-value,significant, reject the null
<br>

### Simple Linear Regression via LS

How does each flux predict Mass Flux? 

```{r}
# plotting each nutrient flux against mass flux

#plot(Data.noNA) # we see some relationships between mass flux and the rest of the nutrient fluxes
par(mfrow=c(1,3))
plot(log(Data.noNA$C_avg),log(Data.noNA$M_avg)) #good linearity, but clumping
lmfit_C.M <- lm(log(M_avg) ~ log(C_avg), data = Data.noNA)
summary(lmfit_C.M)
abline(lmfit_C.M)

plot(log(Data.noNA$N_avg),log(Data.noNA$M_avg)) # alright linearity, still clumping 
lmfit_N.M <- lm(log(M_avg) ~ log(N_avg), data = Data.noNA)
summary(lmfit_N.M)
abline(lmfit_N.M)

plot(log(Data.noNA$P_avg),log(Data.noNA$M_avg)) # worse, still clumping 
lmfit_P.M <- lm(log(M_avg) ~ log(P_avg), data = Data.noNA)
summary(lmfit_P.M)
abline(lmfit_P.M)

```

##Both predictors had to be log transformed in order to make this data more linear with less clumping for all fluxes
##For C flux, multilple r squared is 0.7405, so pretty good fit. Some clumping still
##For N flux, multiple r squared is 0.6446, so still pretty decent, just not as strong as C flux. Some clumping still
##For P flux, multiple r squared is 0.3592, so very poor fit and a lot of clumping.

<br>

Carbon flux seems to be the best predictor of Mass flux. Lets run some EDA. 

```{r}
resids <- resid( lmfit_C.M ) # extract epsilon_hats
fit <- fitted ( lmfit_C.M ) # extract y_hats

par(mfrow=c(1,2))

hist(resids, breaks=20)
qqnorm(resids)
qqline(resids) # add straight line from true normal

plot(resids, main="resid vs i") 
abline(h=0) # mean of epsilon_hat

plot(x=fit, y=resids, main="resid vs y_hat")
abline(h=0)

```

*Not very normal, linearity is okay, but not great, both residual are not very evenly scattered and there is clumping around the line, so not heteroscedasicity, trifecta is broken* 

 <br>
 
Lets compare these EDA's to that of Nitrogen Flux and Mass Flux. Nitrogen Flux was also a strong predictor of Mass Flux. 

```{r}
resids <- resid( lmfit_N.M ) # extract epsilon_hats
fit <- fitted ( lmfit_N.M ) # extract y_hats

par(mfrow=c(1,2))

hist(resids, breaks=20)
qqnorm(resids)
qqline(resids) # add straight line from true normal

plot(resids, main="resid vs i") 
abline(h=0) # mean of epsilon_hat

plot(x=fit, y=resids, main="resid vs y_hat")
abline(h=0)

```

*Not very normal, linearity is okay, but not great, both residual are not very evenly scattered and there is clumping around the line, so not heteroscedasicity, trifecta is broken about the same as C flux* 
 

<br> 

Lets now compare these to Phosphorous Flux, a weak predcitor of Mass Flux. 

```{r}
resids <- resid( lmfit_P.M ) # extract epsilon_hats
fit <- fitted ( lmfit_P.M ) # extract y_hats

par(mfrow=c(1,2))

hist(resids, breaks=20)
qqnorm(resids)
qqline(resids) # add straight line from true normal

plot(resids, main="resid vs i") 
abline(h=0) # mean of epsilon_hat

plot(x=fit, y=resids, main="resid vs y_hat")
abline(h=0)

```

*Somewhat normal, linearity is okay, but not great, both residual are not very evenly scattered and there is clumping around the line, so not heteroscedasicity, trifecta is broken* 
 

<br>

Lets combine the fluxes

```{r}
Data.noNA$flux <- Data.noNA$C_avg - Data.noNA$N_avg - Data.noNA$P_avg #combine the fluxes

lmfit.flux <- lm(M_avg ~ flux,
         data=Data.noNA)
summary(lmfit.flux)
plot(Data.noNA$flux, Data.noNA$M_avg)
abline(lmfit.flux)

resids <- resid( lmfit.flux ) # extract epsilon_hats
fit <- fitted ( lmfit.flux ) # extract y_hats

par(mfrow=c(1,2))

hist(resids, breaks=20)
qqnorm(resids)
qqline(resids) # add straight line from true normal

plot(resids, main="resid vs i") 
abline(h=0) # mean of epsilon_hat

plot(x=fit, y=resids, main="resid vs y_hat")
abline(h=0)

```

*Multiple r-squared is 0.9103, so very strong, but there is a lot of clumping, perhaps we should log transform, fairly normal, not linear, residuals show a lot of clumping*


How does depth affect flux? 

```{r}
# dept v. average for C_avg

par(mfrow=c(1,4))

plot(Data.noNA$dep, log(Data.noNA$C_avg))
lmfit_Dep.C <- lm(log(C_avg) ~ dep, data = Data.noNA)
summary(lmfit_Dep.C)
abline(lmfit_Dep.C)

plot(Data.noNA$dep, log(Data.noNA$N_avg))
lmfit_Dep.N <- lm(log(N_avg) ~ dep, data = Data.noNA)
summary(lmfit_Dep.N)
abline(lmfit_Dep.N)

plot(Data.noNA$dep, log(Data.noNA$P_avg))
lmfit_Dep.P <- lm(log(P_avg) ~ dep, data = Data.noNA)
summary(lmfit_Dep.P)
abline(lmfit_Dep.P)

plot(Data.noNA$dep, log(Data.noNA$M_avg))
lmfit_Dep.M <- lm(log(M_avg) ~ dep, data = Data.noNA)
summary(lmfit_Dep.M)
abline(lmfit_Dep.M)
```

##shows that as depth decreases so does flux, depth can be a prdictor of flux

### Multiple regression 

```{r}

lmfit.MR <- lm(M_avg ~ flux + dep, data = Data.noNA)
summary(lmfit.MR)

resids <- resid( lmfit.MR ) # extract epsilon_hats
fit <- fitted ( lmfit.MR ) # extract y_hats

par(mfrow=c(1,2))

hist(resids, breaks=20)
qqnorm(resids)
qqline(resids) # add straight line from true normal

plot(resids, main="resid vs i") 
abline(h=0) # mean of epsilon_hat

plot(x=fit, y=resids, main="resid vs y_hat")
abline(h=0)
```

*Multiple r-squared is 0.9128, so very strong, somewhat normal, not linear,  residuals show a lot of clumping, perhaps log transform*

*which one is better? I think they both look equally as bad lol* 

```{r}
smaller <- lmfit.flux; larger <- lmfit.MR
anova(smaller, larger)
```

*No significant differnce between each of the outputs*

### ANCOVA 

```{r}
#we want to make predictions on the Mass average flux. 

# we want to compare this against depth and C,N,P fluxes 

# Depth is categorical 
# N,P,C are numerical 

library(psych) # for `pairs.panels()`
library(lattice)

ANOCOVA.data <- subset(Data.noNA, select = c("dep", "M_avg", "C_avg","N_avg","P_avg"))
as.character(ANOCOVA.data$dep) # need to make dep categorical not numerical 
attach(ANOCOVA.data)

summary(ANOCOVA.data)

pairs.panels(data.frame(dep,C_avg,N_avg, P_avg, M_avg))

xyplot(M_avg ~ C_avg | dep, 
                  main="Fig2a: Activity level-specific scatterplots"
           )

    xyplot(M_avg ~ C_avg, groups=dep, 
                  auto.key=TRUE,
                  main="Fig2b: Scatterplot with color=group level"
           )
    
    xyplot(M_avg ~ C_avg, groups=dep, 
                  type=c("p","r"), # `p` for _points_, `r` for _regression line_
                                   # see https://stackoverflow.com/questions/12972039/plotting-xyplot-with-regression-line-on-lattice-graphics for more
                  auto.key=TRUE,
                  main="Fig3: Three standalone depth level-specific `lm()` fits"
           )
```

##These are not looking like good predictors, a lot of clumping, not normal, not linear, try log transform or squaring??
```{r}
#reformat yymmdd so that r can better use it blocking factors 

# only yymmdd1 was used to create new year and month columns since yymmdd1 and yymmdd2 sampled were only a couple days apart and were averaged out in flux columns

Data.noNA$Date <- as.Date(paste(substr(Data.noNA$yymmdd1,1,4),
                                         substr(Data.noNA$yymmdd1,5,6),
                                         substr(Data.noNA$yymmdd1,7,8), sep = "-"),
                                   format = '%Y-%m-%d')

Data.noNA$Year <- substr(Data.noNA$yymmdd1,1,4)

#install.packages("lubridate")
library(lubridate)                            
Data.noNA$month <- as.Date(paste(substr(Data.noNA$yymmdd1,5,6),
                              substr(Data.noNA$yymmdd1,7,8), sep = "-"),
                        format = '%m-%d')           
Data.noNA$month <- round_date(Data.noNA$month, unit = "month")
Data.noNA$month <- format(Data.noNA$month,format = "%Y-%b-%d")
Data.noNA$month <- substr(paste(Data.noNA$month),6,8)

```


```{r}
ANOCOVA.data <- subset(Data.noNA, select = c("dep", "M_avg", "C_avg","N_avg","P_avg", "Year", "month"))
ANOCOVA.data <- as.vector(ANOCOVA.data)
ANCOVA <- lm(log(M_avg) ~ log(C_avg) + log(N_avg) + log(P_avg) + dep + as.factor(Year) + as.factor(month),data = ANOCOVA.data)
summary(ANCOVA)
plot(ANCOVA)
resids <- resid(ANCOVA)
fit <-fitted(ANCOVA)
```

##This doesn't look too hot lol

# Results discussion:

# Limitations:

# References:

