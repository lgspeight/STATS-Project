---
title: "Project.Final"
author: "Leslie Speight Youtsey and Liz Weatherup"
date: "11/13/2020"
output:
  html_document:
    df_print: paged
---

# Title : Fluxes in the ocean 

# Abstract: 

# Introduction: 

# Toolbox discussion:

# Description:

# Implementation:

### Reading csv data in 

```{r}
rm(list=ls(all=TRUE))  #Housekeeping: clear out old files

options(warn = -1)
knitr::opts_chunk$set(echo = T, fig.height=6, fig.width=8, warning = F, message = F) 

```

```{r, eval=TRUE}
bats_flux <- read.csv("bats_flux.csv")

delete.na <- function(DF, n=0) {
  DF[rowSums(is.na(DF)) <= n,]
} #Function that takes rows out that contains NAs 
bats_flux.noNA <- delete.na(bats_flux) # Take out rows containing NAs 


Data <- subset(bats_flux,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","M_avg","C_avg","N_avg","P_avg"))
Data.noNA <- delete.na(Data)

```

### Subsetting each flux out seperatly 

```{r,eval=TRUE}
# separate each flux into its own dataframe 
# delete rows that contain NAs 
C_flux.data <- delete.na(subset(Data,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","C_avg")))
N_flux.data <- delete.na(subset(Data,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","N_avg")))
P_flux.data <- delete.na(subset(Data,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","P_avg")))
M_flux.data <- delete.na(subset(Data,select = c("cr","dep","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2","M_avg")))
```

### Subseting each depth and Renaming Columns 

```{r,eval=TRUE}
# Subset each depth and rename columns 
library(plyr)
C_flux.depth.150 <- subset(C_flux.data, dep == 150)
C_flux.depth.150 <- rename(C_flux.depth.150,c("dep.150" = "dep"))
C_flux.depth.150 <- rename(C_flux.depth.150, c("C_avg.150" = "C_avg" ))
C_flux.depth.200 <- subset(C_flux.data, dep == 200)
C_flux.depth.200 <- rename(C_flux.depth.200, c("dep.200"="dep"))
C_flux.depth.200 <- rename(C_flux.depth.200, c("C_avg.200" ="C_avg"))
C_flux.depth.300 <- subset(C_flux.data, dep == 300)
C_flux.depth.300 <- rename(C_flux.depth.300, c("dep.300"="dep"))
C_flux.depth.300 <- rename(C_flux.depth.300, c("C_avg.300" ="C_avg"))
C_flux.depth.400 <- subset(C_flux.data, dep == 400)
C_flux.depth.400 <- rename(C_flux.depth.400, c("dep.400"="dep"))
C_flux.depth.400 <- rename(C_flux.depth.400, c("C_avg.400" ="C_avg"))
```

```{r,eval=TRUE}
N_flux.depth.150 <- subset(N_flux.data, dep == 150)
N_flux.depth.150 <- rename(N_flux.depth.150, c("dep.150"="dep"))
N_flux.depth.150 <- rename(N_flux.depth.150, c("N_avg.150" ="N_avg"))
N_flux.depth.200 <- subset(N_flux.data, dep == 200)
N_flux.depth.200 <- rename(N_flux.depth.200, c("dep.200"="dep"))
N_flux.depth.200 <- rename(N_flux.depth.200, c("N_avg.200" ="N_avg"))
N_flux.depth.300 <- subset(N_flux.data, dep == 300)
N_flux.depth.300 <- rename(N_flux.depth.300, c("dep.300"="dep"))
N_flux.depth.300 <- rename(N_flux.depth.300, c("N_avg.300" ="N_avg"))
N_flux.depth.400 <- subset(N_flux.data, dep == 400)
N_flux.depth.400 <- rename(N_flux.depth.400, c("dep.400"="dep"))
N_flux.depth.400 <- rename(N_flux.depth.400, c("N_avg.400" ="N_avg"))
```

```{r,eval=TRUE}
P_flux.depth.150 <- subset(P_flux.data, dep == 150)
P_flux.depth.150 <- rename(P_flux.depth.150, c("dep.150"="dep"))
P_flux.depth.150 <- rename(P_flux.depth.150, c("P_avg.150" ="P_avg"))
P_flux.depth.200 <- subset(P_flux.data, dep == 200)
P_flux.depth.200 <- rename(P_flux.depth.200, c("dep.200"="dep"))
P_flux.depth.200 <- rename(P_flux.depth.200, c("P_avg.200" ="P_avg"))
P_flux.depth.300 <- subset(P_flux.data, dep == 300)
P_flux.depth.300 <- rename(P_flux.depth.300, c("dep.300"="dep"))
P_flux.depth.300 <- rename(P_flux.depth.300, c("P_avg.300" ="P_avg"))
P_flux.depth.400 <- subset(P_flux.data, dep == 400)
P_flux.depth.400 <- rename(P_flux.depth.400, c("dep.400"="dep"))
P_flux.depth.400 <- rename(P_flux.depth.400, c("P_avg.400" ="P_avg"))
```

```{r,eval=TRUE}
M_flux.depth.150 <- subset(M_flux.data, dep == 150)
M_flux.depth.150 <- rename(M_flux.depth.150, c("dep.150"="dep"))
M_flux.depth.150 <- rename(M_flux.depth.150, c("M_avg.150" ="M_avg"))
M_flux.depth.200 <- subset(M_flux.data, dep == 200)
M_flux.depth.200 <- rename(M_flux.depth.200, c("dep.200"="dep"))
M_flux.depth.200 <- rename(M_flux.depth.200, c("M_avg.200" ="M_avg"))
M_flux.depth.300 <- subset(M_flux.data, dep == 300)
M_flux.depth.300 <- rename(M_flux.depth.300, c("dep.300"="dep"))
M_flux.depth.300 <- rename(M_flux.depth.300, c("M_avg.300" ="M_avg"))
M_flux.depth.400 <- subset(M_flux.data, dep == 400)
M_flux.depth.400 <- rename(M_flux.depth.400, c("dep.400"="dep"))
M_flux.depth.400 <- rename(M_flux.depth.400, c("M_avg.400" ="M_avg"))
```

### Bar plots to access relationship between fluxes and depths 


### Paired sample t test for each depth and the depth below it 

This is a paired test because samples were collected on the same cruise and at the same location. So for each flux value at one depth, there was a flux value collected at a different depth at the same location!
Data frames were merged based on cruise, year, and location to have the same number of values.  

For a paired t test to be preformed it must meet these assumptions:

-The dependent variable must be continuous (interval/ratio).
-The observations are independent of one another.
-The dependent variable should be approximately normally distributed.
-The dependent variable should not contain any outliers.


```{r,eval=TRUE}
# Checking for normaility and no outliers in Carbon Flux 

hist((C_flux.depth.150$C_avg.150), breaks = "FD")
hist((C_flux.depth.200$C_avg.200), breaks = "FD")
hist((C_flux.depth.300$C_avg.300), breaks = "FD")
hist((C_flux.depth.400$C_avg.400), breaks = "FD")

# using natural log to Transform the data 

hist(log(C_flux.depth.150$C_avg.150))
hist(log(C_flux.depth.200$C_avg.200))
hist(log(C_flux.depth.300$C_avg.300))
hist(log(C_flux.depth.400$C_avg.400))

# Checking for outliers

boxplot(log(C_flux.depth.150$C_avg.150))
boxplot(log(C_flux.depth.200$C_avg.200))
boxplot(log(C_flux.depth.300$C_avg.300))
boxplot(log(C_flux.depth.400$C_avg.400))
```

*Comment on these assumptions* 

```{r,eval=TRUE}
# Checking for normaility and no outliers in Nitrogen Flux 

hist((N_flux.depth.150$N_avg.150), breaks = "FD")
hist((N_flux.depth.200$N_avg.200), breaks = "FD")
hist((N_flux.depth.300$N_avg.300), breaks = "FD")
hist((N_flux.depth.400$N_avg.400), breaks = "FD")

# using natural log to Transform the data 

hist(log(N_flux.depth.150$N_avg.150))
hist(log(N_flux.depth.200$N_avg.200))
hist(log(N_flux.depth.300$N_avg.300))
hist(log(N_flux.depth.400$N_avg.400))

# Checking for outliers

boxplot(log(N_flux.depth.150$N_avg.150))
boxplot(log(N_flux.depth.200$N_avg.200))
boxplot(log(N_flux.depth.300$N_avg.300))
boxplot(log(N_flux.depth.400$N_avg.400))
```

*Comment on these assumptions* 

```{r,eval=TRUE}
# Checking for normaility and no outliers in Phosporous Flux 

hist((P_flux.depth.150$P_avg.150), breaks = "FD")
hist((P_flux.depth.200$P_avg.200), breaks = "FD")
hist((P_flux.depth.300$P_avg.300), breaks = "FD")

# using natural log to Transform the data 

hist(log(P_flux.depth.150$P_avg.150))
hist(log(P_flux.depth.200$P_avg.200))
hist(log(P_flux.depth.300$P_avg.300))

# Checking for outliers

boxplot(log(P_flux.depth.150$P_avg.150))
boxplot(log(P_flux.depth.200$P_avg.200))
boxplot(log(P_flux.depth.300$P_avg.300))
```

*comment on these assumptions*


```{r,eval=TRUE}
# Checking for normaility and no outliers in Mass Flux 

hist((M_flux.depth.150$M_avg.150), breaks = "FD")
hist((M_flux.depth.200$M_avg.200), breaks = "FD")
hist((M_flux.depth.300$M_avg.300), breaks = "FD")
hist((M_flux.depth.400$M_avg.400), breaks = "FD")

# using natural log to Transform the data 

hist(log(M_flux.depth.150$M_avg.150))
hist(log(M_flux.depth.200$M_avg.200))
hist(log(M_flux.depth.300$M_avg.300))
hist(log(M_flux.depth.400$M_avg.400))

# Checking for outliers

boxplot(log(M_flux.depth.150$M_avg.150))
boxplot(log(M_flux.depth.200$M_avg.200))
boxplot(log(M_flux.depth.300$M_avg.300))
boxplot(log(M_flux.depth.400$M_avg.400))
```

*comment on these assumptions*

<br>

*Since many of the 400 m depth distrubutions were not normal, even after transformation and have small n, they will not be used in the hypothesis testing* 


(1.1)

$\mu_1$ = mean Carbon flux at depth 150
$\mu_2$ = mean Carbon flux at depth 200

$H_0$ : Carbon flux does not change between 150 and 200 meter. $\mu_1$ = $\mu_2$
$H_1$ : Carbon flux is lower at 200 meter then at 150 meter. $\mu_1$ > $\mu_2$



```{r}
C.depth.150.200 <- merge(C_flux.depth.150,C_flux.depth.200,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))

t.test(log(C.depth.150.200$C_avg.150) ,log(C.depth.150.200$C_avg.200), alternative = "greater", paired = TRUE, var.equal = TRUE)

```

(1.2)

$\mu_1$ = mean Carbon flux at depth 200
$\mu_2$ = mean Carbon flux at depth 300

$H_0$ : Carbon flux does not change between 200 and 300 meter. $\mu_1$ = $\mu_2$
$H_1$ : Carbon flux is lower at 300 meter then at 200 meter. $\mu_1$ > $\mu_2$

```{r}
C.depth.200.300 <- merge(C_flux.depth.200,C_flux.depth.300,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))

t.test(log(C.depth.200.300$C_avg.200) ,log(C.depth.200.300$C_avg.300), alternative = "greater", paired = TRUE, var.equal = TRUE)
```


(2.1)

$\mu_1$ = mean Nitrogen flux at depth 150
$\mu_2$ = mean Nitrogen flux at depth 200

$H_0$ : Nitrogen flux does not change between 150 and 200 meter. $\mu_1$ = $\mu_2$
$H_1$ : Nitrogen flux is lower at 200 meter then at 150 meter. $\mu_1$ > $\mu_2$

```{r}
N.depth.150.200 <- merge(N_flux.depth.150,N_flux.depth.200,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))

t.test(log(N.depth.150.200$N_avg.150) ,log(N.depth.150.200$N_avg.200), alternative = "greater", paired = TRUE, var.equal = TRUE)

```

(2.2)

$\mu_1$ = mean Nitrogen flux at depth 200
$\mu_2$ = mean Nitrogen flux at depth 300

$H_0$ : Nitrogen flux does not change between 200 and 300 meter. $\mu_1$ = $\mu_2$
$H_1$ : Nitrogen flux is lower at 300 meter then at 200 meter. $\mu_1$ > $\mu_2$

```{r}
N.depth.200.300 <- merge(N_flux.depth.200,N_flux.depth.300,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))

t.test(log(N.depth.200.300$N_avg.200) ,log(N.depth.200.300$N_avg.300), alternative = "greater", paired = TRUE, var.equal = TRUE)
```

(3.1)

$\mu_1$ = mean Phosporous flux at depth 150
$\mu_2$ = mean Phosporous flux at depth 200

$H_0$ : Phosporous flux does not change between 150 and 200 meter. $\mu_1$ = $\mu_2$
$H_1$ : Phosporous flux is lower at 200 meter then at 150 meter. $\mu_1$ > $\mu_2$

```{r}
P.depth.150.200 <- merge(P_flux.depth.150,P_flux.depth.200,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))

t.test(log(P.depth.150.200$P_avg.150) ,log(P.depth.150.200$P_avg.200), alternative = "greater", paired = TRUE, var.equal = TRUE)

```

(3.2)

$\mu_1$ = mean Phosporous flux at depth 200
$\mu_2$ = mean Phosporous flux at depth 300

$H_0$ : Phosporous flux does not change between 200 and 300 meter. $\mu_1$ = $\mu_2$
$H_1$ : Phosporous flux is lower at 300 meter then at 200 meter. $\mu_1$ > $\mu_2$

```{r}
P.depth.200.300 <- merge(P_flux.depth.200,P_flux.depth.300,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))

t.test(log(P.depth.200.300$P_avg.200) ,log(P.depth.200.300$P_avg.300), alternative = "greater", paired = TRUE, var.equal = TRUE)
```

(4.1)

$\mu_1$ = mean Mass flux at depth 150
$\mu_2$ = mean Mass flux at depth 200

$H_0$ : Mass flux does not change between 150 and 200 meter. $\mu_1$ = $\mu_2$
$H_1$ : Mass flux is lower at 200 meter then at 150 meter. $\mu_1$ > $\mu_2$

```{r}
M.depth.150.200 <- merge(M_flux.depth.150,M_flux.depth.200,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))

t.test(log(M.depth.150.200$M_avg.150) ,log(M.depth.150.200$M_avg.200), alternative = "greater", paired = TRUE, var.equal = TRUE)

```

(4.2)

$\mu_1$ = mean Mass flux at depth 200
$\mu_2$ = mean Mass flux at depth 300

$H_0$ : Mass flux does not change between 200 and 300 meter. $\mu_1$ = $\mu_2$
$H_1$ : Mass flux is lower at 300 meter then at 200 meter. $\mu_1$ > $\mu_2$

```{r}
M.depth.200.300 <- merge(M_flux.depth.200,M_flux.depth.300,by = c("cr","yymmdd1","yymmdd2","Lat2","Lat2.1","Long1","Long2"))

t.test(log(M.depth.200.300$M_avg.200) ,log(M.depth.200.300$M_avg.300), alternative = "greater", paired = TRUE, var.equal = TRUE)
```

<br>

### Simple Linear Regression via LS

How does each flux predict Mass Flux? 

```{r}
# plotting each nutrient flux against mass flux

plot(Data.noNA) # we see some relationships between mass flux and the rest of the nutrient fluxes

plot(Data.noNA$C_avg,Data.noNA$M_avg) #good linearity, but clumping
lmfit_C.M <- lm(M_avg ~ C_avg, data = Data.noNA)
summary(lmfit_C.M)
abline(lmfit_C.M)

plot(Data.noNA$N_avg,Data.noNA$M_avg) # alright linearity, still clumping 
lmfit_N.M <- lm(M_avg ~ N_avg, data = Data.noNA)
summary(lmfit_N.M)
abline(lmfit_N.M)

plot(Data.noNA$P_avg,Data.noNA$M_avg) # worse, still clumping 
lmfit_P.M <- lm(M_avg ~ P_avg, data = Data.noNA)
summary(lmfit_P.M)
abline(lmfit_P.M)

```
*comment on these outputs* 

<br>

Carbon flux seems to be the best predictor of Mass flux. Lets run some EDA. 

```{r}
resids <- resid( lmfit_C.M ) # extract epsilon_hats
fit <- fitted ( lmfit_C.M ) # extract y_hats

par(mfrow=c(1,2))

hist(resids, breaks=20)
qqnorm(resids)
qqline(resids) # add straight line from true normal

plot(resids, main="resid vs i") 
abline(h=0) # mean of epsilon_hat

plot(x=fit, y=resids, main="resid vs y_hat")
abline(h=0)

```

*Comment on these* 

 <br>
 
Lets compare these EDA's to that of Nitrogen Flux and Mass Flux. Nitrogen Flux was also a strong predictor of Mass Flux. 

```{r}
resids <- resid( lmfit_N.M ) # extract epsilon_hats
fit <- fitted ( lmfit_N.M ) # extract y_hats

par(mfrow=c(1,2))

hist(resids, breaks=20)
qqnorm(resids)
qqline(resids) # add straight line from true normal

plot(resids, main="resid vs i") 
abline(h=0) # mean of epsilon_hat

plot(x=fit, y=resids, main="resid vs y_hat")
abline(h=0)

```

*comment of these* 

<br> 

Lets now compare these to Phosphorous Flux, a weak predcitor of Mass Flux. 

```{r}
resids <- resid( lmfit_P.M ) # extract epsilon_hats
fit <- fitted ( lmfit_P.M ) # extract y_hats

par(mfrow=c(1,2))

hist(resids, breaks=20)
qqnorm(resids)
qqline(resids) # add straight line from true normal

plot(resids, main="resid vs i") 
abline(h=0) # mean of epsilon_hat

plot(x=fit, y=resids, main="resid vs y_hat")
abline(h=0)

```

*comment on these* 

<br>


```{r}
flux <- Data.noNA$C_avg - Data.noNA$N_avg - Data.noNA$P_avg #combine the fluxes

lmfit.flux <- lm( M_avg ~ flux,
         data=Data.noNA)
summary(lmfit.flux)
plot(flux,Data.noNA$M_avg)
abline(lmfit.flux)

resids <- resid( lmfit.flux ) # extract epsilon_hats
fit <- fitted ( lmfit.flux ) # extract y_hats

par(mfrow=c(1,2))

hist(resids, breaks=20)
qqnorm(resids)
qqline(resids) # add straight line from true normal

plot(resids, main="resid vs i") 
abline(h=0) # mean of epsilon_hat

plot(x=fit, y=resids, main="resid vs y_hat")
abline(h=0)

```

*comment on this*


How does depth affect flux? 

```{r}
# dept v. average for C_avg
plot(Data.noNA$dep, Data.noNA$C_avg)
lmfit_Dep.C <- lm(C_avg ~ dep, data = Data.noNA)
summary(lmfit_Dep.C)
abline(lmfit_Dep.C)

plot(Data.noNA$dep, Data.noNA$N_avg)
lmfit_Dep.N <- lm(N_avg ~ dep, data = Data.noNA)
summary(lmfit_Dep.N)
abline(lmfit_Dep.N)

plot(Data.noNA$dep, Data.noNA$P_avg)
lmfit_Dep.P <- lm(P_avg ~ dep, data = Data.noNA)
summary(lmfit_Dep.P)
abline(lmfit_Dep.P)

plot(Data.noNA$dep, Data.noNA$M_avg)
lmfit_Dep.M <- lm(M_avg ~ dep, data = Data.noNA)
summary(lmfit_Dep.M)
abline(lmfit_Dep.M)
```


### Multiple regression 

```{r}

lmfit.MR <- lm(M_avg ~ flux + dep, data = Data.noNA)
summary(lmfit.MR)

```

*which one is better?* 

```{r}
smaller <- lmfit.flux; larger <- lmfit.MR
anova(smaller, larger)
```


### ANCOVA 

```{r}
#we want to make predictions on the Mass average flux. 

# we want to compare this against depth and C,N,P fluxes 

# Depth is categorical 
# N,P,C are numerical 

library(psych) # for `pairs.panels()`
library(lattice)

ANOCOVA.data <- subset(Data.noNA, select = c("dep", "M_avg", "C_avg","N_avg","P_avg"))
as.character(ANOCOVA.data$dep) # need to make dep categorical not numerical 
attach(ANOCOVA.data)

summary(ANOCOVA.data)

pairs.panels(data.frame(dep,C_avg,N_avg, P_avg, M_avg))

xyplot(M_avg ~ C_avg | dep, 
                  main="Fig2a: Activity level-specific scatterplots"
           )

    xyplot(M_avg ~ C_avg, groups=dep, 
                  auto.key=TRUE,
                  main="Fig2b: Scatterplot with color=group level"
           )
    
    xyplot(M_avg ~ C_avg, groups=dep, 
                  type=c("p","r"), # `p` for _points_, `r` for _regression line_
                                   # see https://stackoverflow.com/questions/12972039/plotting-xyplot-with-regression-line-on-lattice-graphics for more
                  auto.key=TRUE,
                  main="Fig3: Three standalone depth level-specific `lm()` fits"
           )
```

```{r}
#reformat yymmdd so that r can better use it blocking factors 

# only yymmdd1 was used to create new year and month columns since yymmdd1 and yymmdd2 sampled were only a couple days apart and were averaged out in flux columns

Data.noNA$Date <- as.Date(paste(substr(Data.noNA$yymmdd1,1,4),
                                         substr(Data.noNA$yymmdd1,5,6),
                                         substr(Data.noNA$yymmdd1,7,8), sep = "-"),
                                   format = '%Y-%m-%d')

Data.noNA$Year <- substr(Data.noNA$yymmdd1,1,4)

#install.packages("lubridate")
library(lubridate)                            
Data.noNA$month <- as.Date(paste(substr(Data.noNA$yymmdd1,5,6),
                              substr(Data.noNA$yymmdd1,7,8), sep = "-"),
                        format = '%m-%d')           
Data.noNA$month <- round_date(Data.noNA$month, unit = "month")
Data.noNA$month <- format(Data.noNA$month,format = "%Y-%b-%d")
Data.noNA$month <- substr(paste(Data.noNA$month),6,8)

```


```{r}
ANOCOVA.data <- subset(Data.noNA, select = c("dep", "M_avg", "C_avg","N_avg","P_avg", "Year", "month"))
ANOCOVA.data <- as.vector(ANOCOVA.data)
ANCOVA <- lm(log(M_avg) ~ log(C_avg) + log(N_avg) + log(P_avg) + dep + as.factor(Year) + as.factor(month),data = ANOCOVA.data)
summary(ANCOVA)
plot(ANCOVA)
resids <- resid(ANCOVA)
fit <-fitted(ANCOVA)
```

# Results discussion:

# Limitations:

# References:

